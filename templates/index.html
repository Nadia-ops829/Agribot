<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agribot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  {% csrf_token %}
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            eee: '#EEEEEE',
            ccc: '#BFBFBF',
          }
        }
      }
    }
  </script>
  <style>
    * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Indicateur de saisie du bot */
    .typing-indicator {
      display: inline-block;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #9ca3af;
      margin: 0 1px;
      animation: typing 1.4s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>

<body class="bg-white dark:bg-gray-900 min-h-screen flex flex-col">

  <!-- Bouton thÃ¨me -->
  <div class="fixed top-4 right-4 z-50">
    <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-300">
      <svg id="theme-icon-light" class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
      </svg>
      <svg id="theme-icon-dark" class="w-6 h-6 text-blue-400 hidden" fill="currentColor" viewBox="0 0 20 20">
        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
      </svg>
    </button>
  </div>

  <!-- Fond + contenu centrÃ© -->
  <div class="flex-1 bg-gradient-to-tr from-eee to-neutral-200 dark:from-gray-800 dark:to-gray-900 flex flex-col">
    <div class="flex-1 overflow-y-auto px-4 pt-20 pb-32" id="chat-container">
      <div class="w-[90%] max-w-2xl mx-auto">

        <!-- Titre -->
        <div class="text-center mb-12">
          <h1 class="bg-gradient-to-r from-black via-pink-500 to-violet-800 dark:from-white dark:via-pink-400 dark:to-violet-600 inline-block text-transparent bg-clip-text font-normal text-5xl leading-tight">
            Salut je suis Agribot
          </h1><br>
          <h1 class="bg-gradient-to-r from-black via-pink-500 to-violet-800 dark:from-white dark:via-pink-400 dark:to-violet-600 inline-block text-transparent bg-clip-text font-normal text-4xl -mt-2 mb-2 leading-tight">
            Comment puis-je vous aider aujourd'hui ?
          </h1>
        </div>

        <!-- Suggestions -->
        <div id="suggestions" class="flex flex-col sm:flex-row gap-3 mb-8 text-sm text-neutral-800 dark:text-gray-300">
          <div onclick="quickQuestion(this)" class="group relative grow border border-ccc shadow-sm hover:shadow-md hover:-translate-y-[1px] hover:bg-neutral-100/30 dark:border-gray-700 dark:hover:bg-gray-800/30 rounded-xl p-4 transition-all duration-300 cursor-pointer">
            Quel est le prix du maÃ¯s ?
            <svg class="absolute right-2 bottom-2 h-4 text-neutral-500 dark:text-gray-400 opacity-0 -translate-x-4 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300" fill="currentColor" viewBox="0 0 16 16"><path d="M2 8a.75.75 0 0 1 .75-.75h8.787L8.25 4.309a.75.75 0 0 1 1-1.118L14 7.441a.75.75 0 0 1 0 1.118l-4.75 4.25a.75.75 0 1 1-1-1.118l3.287-2.941H2.75A.75.75 0 0 1 2 8z"/></svg>
          </div>
          <div onclick="quickQuestion(this)" class="group relative grow border border-ccc shadow-sm hover:shadow-md hover:-translate-y-[1px] hover:bg-neutral-100/30 dark:border-gray-700 dark:hover:bg-gray-800/30 rounded-xl p-4 transition-all duration-300 cursor-pointer">
            Comment lutter contre le striga ?
            <svg class="absolute right-2 bottom-2 h-4 text-neutral-500 dark:text-gray-400 opacity-0 -translate-x-4 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300" fill="currentColor" viewBox="0 0 16 16"><path d="M2 8a.75.75 0 0 1 .75-.75h8.787L8.25 4.309a.75.75 0 0 1 1-1.118L14 7.441a.75.75 0 0 1 0 1.118l-4.75 4.25a.75.75 0 1 1-1-1.118l3.287-2.941H2.75A.75.75 0 0 1 2 8z"/></svg>
          </div>
          <div onclick="quickQuestion(this)" class="group relative grow border border-ccc shadow-sm hover:shadow-md hover:-translate-y-[1px] hover:bg-neutral-100/30 dark:border-gray-700 dark:hover:bg-gray-800/30 rounded-xl p-4 transition-all duration-300 cursor-pointer">
            Comment amÃ©liorer la fertilitÃ© de mon sol ?
            <svg class="absolute right-2 bottom-2 h-4 text-neutral-500 dark:text-gray-400 opacity-0 -translate-x-4 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300" fill="currentColor" viewBox="0 0 16 16"><path d="M2 8a.75.75 0 0 1 .75-.75h8.787L8.25 4.309a.75.75 0 0 1 1-1.118L14 7.441a.75.75 0 0 1 0 1.118l-4.75 4.25a.75.75 0 1 1-1-1.118l3.287-2.941H2.75A.75.75 0 0 1 2 8z"/></svg>
          </div>
        </div>

        <!-- Zone des messages -->
        <div id="chat-messages" class="space-y-4">
          <!-- Messages initiaux -->
          <div class="flex items-start space-x-3 fade-in">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-pink-500 to-violet-600 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
              </svg>
            </div>
            <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-none px-5 py-3 shadow-md max-w-lg">
              <p class="text-gray-800 dark:text-gray-200">Wend na kodÃ´ ! Je suis Agribot, prÃªt Ã  t'aider sur le terrain ! ðŸŒ¾</p>
            </div>
          </div>
        </div>

        <!-- Indicateur de saisie (cachÃ© par dÃ©faut) -->
        <div id="typing-indicator" class="hidden flex items-start space-x-3 mt-4">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-pink-500 to-violet-600 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-none px-5 py-3">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Zone de saisie -->
    <div class="w-[90%] max-w-2xl mx-auto pb-6 px-4">
      <div class="bg-white dark:bg-gray-800 h-28 rounded-2xl shadow-md border border-neutral-200 dark:border-gray-700 relative">
        <textarea id="user-input" 
                  class="w-full h-full px-6 py-6 bg-transparent outline-none resize-none dark:text-gray-300 placeholder-gray-500" 
                  placeholder="Posez moi une question ..."
                  rows="1"></textarea>
        <button id="send-btn" class="absolute right-4 bottom-4 bg-black dark:bg-gray-700 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:shadow-xl active:scale-95 transition-all duration-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 512 512">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="48" d="M112 244l144-144l144 144M256 120v292"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // === ThÃ¨me ===
    const themeToggle = document.getElementById('theme-toggle');
    const light = document.getElementById('theme-icon-light');
    const dark = document.getElementById('theme-icon-dark');
    
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
      light.classList.add('hidden');
      dark.classList.remove('hidden');
    }
    
    themeToggle.onclick = () => {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      light.classList.toggle('hidden', isDark);
      dark.classList.toggle('hidden', !isDark);
    };

    // CSRF
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Ã‰lÃ©ments DOM
    const chat = document.getElementById('chat-messages');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestions = document.getElementById('suggestions');
    const typingIndicator = document.getElementById('typing-indicator');
    const chatContainer = document.getElementById('chat-container');

    // Auto-resize de la zone de texte
    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = (textarea.scrollHeight) + 'px';
    }

    // Ajouter un message
    function addMessage(text, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `fade-in flex items-start space-x-3 ${isUser ? 'justify-end' : ''}`;
      
      if (isUser) {
        messageDiv.innerHTML = `
          <div class="bg-gradient-to-r from-pink-500 to-violet-600 text-white rounded-2xl rounded-tr-none px-5 py-3 shadow-md max-w-lg ml-auto">
            <p class="whitespace-pre-line">${text}</p>
          </div>
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-pink-500 to-violet-600 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
        `;
      } else {
        // Formater les rÃ©ponses du chatbot (mise en forme basique)
        let formattedText = text;
        // Remplace **texte** par <strong>
        formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');
        // Remplace les Ã©mojis par des span avec classe
        formattedText = formattedText.replace(/ðŸ’¡/g, '<span class="inline-block mr-1">ðŸ’¡</span>');
        formattedText = formattedText.replace(/ðŸŒ¾/g, '<span class="inline-block mr-1">ðŸŒ¾</span>');
        
        messageDiv.innerHTML = `
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-r from-pink-500 to-violet-600 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
          </div>
          <div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-tl-none px-5 py-3 shadow-md max-w-lg">
            <p class="text-gray-800 dark:text-gray-200 whitespace-pre-line">${formattedText}</p>
          </div>
        `;
      }
      
      chat.appendChild(messageDiv);
      scrollToBottom();
    }

    // Faire dÃ©filer vers le bas
    function scrollToBottom() {
      setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, 100);
    }

    // Afficher/cacher l'indicateur de saisie
    function showTypingIndicator() {
      typingIndicator.classList.remove('hidden');
      scrollToBottom();
    }

    function hideTypingIndicator() {
      typingIndicator.classList.add('hidden');
    }

    // Envoyer un message
    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;
      
      // Ajouter le message de l'utilisateur
      addMessage(message, true);
      input.value = '';
      autoResize(input);
      suggestions.style.display = 'none';
      
      // Afficher l'indicateur de saisie
      showTypingIndicator();
      
      try {
        // Envoyer la requÃªte au backend
        const response = await fetch('/chatbot/', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/x-www-form-urlencoded', 
            'X-CSRFToken': csrftoken 
          },
          body: new URLSearchParams({ message })
        });
        
        const data = await response.json();
        
        // Cacher l'indicateur de saisie
        hideTypingIndicator();
        
        // Ajouter la rÃ©ponse du bot
        if (data.response) {
          addMessage(data.response);
        } else {
          addMessage("DÃ©solÃ©, je n'ai pas pu obtenir de rÃ©ponse.");
        }
        
      } catch (error) {
        console.error('Erreur:', error);
        hideTypingIndicator();
        addMessage("âŒ Erreur de connexion. Veuillez rÃ©essayer.");
      }
    }

    // Questions rapides
    function quickQuestion(element) {
      const question = element.textContent.trim();
      input.value = question;
      autoResize(input);
      sendMessage();
    }

    // Ã‰vÃ©nements
    sendBtn.addEventListener('click', sendMessage);
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
      autoResize(e.target);
    });
    
    input.addEventListener('input', () => {
      autoResize(input);
      if (input.value.trim()) {
        suggestions.style.display = 'none';
      } else {
        suggestions.style.display = 'flex';
      }
    });

    // Initialisation
    window.quickQuestion = quickQuestion;
    
    // Focus sur la zone de texte
    input.focus();
  </script>
</body>
</html>